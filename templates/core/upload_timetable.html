{% extends 'base.html' %}

{% block content %}
{% include 'partials/admin_sidebar.html' %}

<div class="flex-1 flex flex-col h-screen overflow-hidden relative bg-[#f8fafc]">
    <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center px-8 z-40 shrink-0">
        <button id="menuBtn" class="p-2 rounded-lg hover:bg-slate-100 md:hidden mr-2" aria-label="Open sidebar">
            <i class="fa-solid fa-bars text-xl"></i>
        </button>
        <h2 class="text-xl font-bold font-tech text-slate-800 flex items-center gap-3">
            <i class="fa-regular fa-calendar-plus text-slate-400"></i> Upload Timetable PDF
        </h2>
    </header>

    <main class="flex-1 overflow-y-auto p-6 md:p-8 custom-scroll">

        {% if messages %}
        <div class="mb-6 space-y-2 max-w-2xl mx-auto">
            {% for message in messages %}
            <div class="p-4 rounded-xl text-sm font-bold flex items-center gap-3 shadow-sm
                    {% if 'success' in message.tags %}bg-emerald-50 text-emerald-700 border border-emerald-200
                    {% elif 'warning' in message.tags %}bg-amber-50 text-amber-700 border border-amber-200
                    {% else %}bg-red-50 text-red-700 border border-red-200{% endif %}">
                <i
                    class="fa-solid {% if 'success' in message.tags %}fa-check-circle{% elif 'warning' in message.tags %}fa-triangle-exclamation{% else %}fa-exclamation-circle{% endif %} text-lg"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="w-full max-w-2xl mx-auto">

            <!-- Upload Card -->
            <div class="bg-white rounded-[1.5rem] p-8 shadow-sm border border-slate-200 mb-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl bg-red-50 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-file-pdf text-3xl text-red-500"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800">Upload Department Timetable</h3>
                    <p class="text-xs text-slate-400 mt-1">Upload the master PDF â€” slots will be auto-parsed and
                        imported.</p>
                </div>

                <form method="post" action="{% url 'upload_timetable' %}" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}

                    <!-- Drop Zone -->
                    <label id="dropZone"
                        class="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl p-8 mb-6 cursor-pointer hover:border-blue-400 hover:bg-blue-50/30 transition-all duration-200 group"
                        for="fileInput">
                        <i
                            class="fa-solid fa-cloud-arrow-up text-3xl text-slate-300 group-hover:text-blue-500 mb-3 transition-colors"></i>
                        <span id="fileName"
                            class="text-sm font-bold text-slate-500 group-hover:text-blue-600 transition-colors">
                            Click to select PDF or drag & drop
                        </span>
                        <span class="text-[10px] text-slate-400 mt-1">Only .pdf files accepted</span>
                        <input type="file" name="file" id="fileInput" accept=".pdf" class="hidden" required>
                    </label>

                    <!-- Options -->
                    <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl border border-slate-100 mb-6">
                        <input type="checkbox" name="clear_existing" id="clearCheck"
                            class="w-4 h-4 rounded border-slate-300 text-red-500 focus:ring-red-500">
                        <label for="clearCheck" class="text-sm text-slate-700">
                            <span class="font-bold">Clear existing timetable</span>
                            <span class="text-slate-400 text-xs block">Removes all old slots before importing new
                                ones</span>
                        </label>
                    </div>

                    <!-- Submit -->
                    <button type="submit" id="submitBtn"
                        class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-blue-600 hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        <i class="fa-solid fa-upload"></i> Upload & Import Timetable
                    </button>
                </form>
            </div>

            <!-- Results Card (only after upload) -->
            {% if results %}
            <div class="bg-white rounded-[1.5rem] p-8 shadow-sm border border-slate-200">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2 mb-6">
                    <i class="fa-solid fa-chart-bar text-blue-500"></i> Import Results
                </h3>

                <!-- Stats Grid -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="p-4 bg-emerald-50 border border-emerald-100 rounded-xl text-center">
                        <p class="text-2xl font-bold text-emerald-700">{{ results.created }}</p>
                        <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-wide">Created</p>
                    </div>
                    <div class="p-4 bg-blue-50 border border-blue-100 rounded-xl text-center">
                        <p class="text-2xl font-bold text-blue-700">{{ results.updated }}</p>
                        <p class="text-[10px] font-bold text-blue-600 uppercase tracking-wide">Updated</p>
                    </div>
                    <div class="p-4 bg-amber-50 border border-amber-100 rounded-xl text-center">
                        <p class="text-2xl font-bold text-amber-700">{{ results.skipped|length }}</p>
                        <p class="text-[10px] font-bold text-amber-600 uppercase tracking-wide">Skipped</p>
                    </div>
                </div>

                {% if results.skipped %}
                <div class="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-triangle-exclamation text-amber-500"></i> Skipped Entries
                    </h4>
                    <div class="space-y-1 max-h-48 overflow-y-auto custom-scroll">
                        {% for msg in results.skipped %}
                        <p
                            class="text-xs text-slate-600 font-mono bg-white px-3 py-2 rounded-lg border border-slate-100">
                            {{ msg }}</p>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

        </div>

        <div class="h-10"></div>
    </main>
</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const dropZone = document.getElementById('dropZone');

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileName.textContent = fileInput.files[0].name;
            fileName.classList.add('text-blue-600');
            submitBtn.disabled = false;
        }
    });

    // Drag & drop
    dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('border-blue-400', 'bg-blue-50/30');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-400', 'bg-blue-50/30');
    });
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50/30');
        if (e.dataTransfer.files.length > 0 && e.dataTransfer.files[0].name.endsWith('.pdf')) {
            fileInput.files = e.dataTransfer.files;
            fileName.textContent = e.dataTransfer.files[0].name;
            fileName.classList.add('text-blue-600');
            submitBtn.disabled = false;
        }
    });

    // Loading state on submit
    document.getElementById('uploadForm').addEventListener('submit', () => {
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> Processing PDF...';
        submitBtn.disabled = true;
    });
</script>

{% endblock %}